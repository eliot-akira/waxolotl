"use strict";var wat=(()=>{var N=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var K=Object.prototype.hasOwnProperty;var Q=(s,e)=>{for(var t in e)N(s,t,{get:e[t],enumerable:!0})},Z=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let f of W(e))!K.call(s,f)&&f!==t&&N(s,f,{get:()=>e[f],enumerable:!(r=J(e,f))||r.enumerable});return s};var ee=s=>Z(N({},"__esModule",{value:!0}),s);var ce={};Q(ce,{FunctionContext:()=>M,GlobalContext:()=>E,ModuleBuilder:()=>O,compile:()=>U,default:()=>Y,parse:()=>B,tokenize:()=>L});var p={"type.i32":127,"type.i64":126,"type.f32":125,"type.f64":124,"type.void":64,"type.func":96,"type.funcref":112,"section.custom":0,"section.type":1,"section.import":2,"section.function":3,"section.table":4,"section.memory":5,"section.global":6,"section.export":7,"section.start":8,"section.element":9,"section.code":10,"section.data":11,"import.func":0,"import.table":1,"import.memory":2,"import.global":3,"export.function":0,"export.table":1,"export.memory":2,"export.global":3,"global.const":0,"global.var":1,"global.mut":1,"limits.min":0,"limits.minmax":1,"limits.shared":3},q=["unreachable","nop","block","loop","if","else",,,,,,"end","br","br_if","br_table","return","call","call_indirect",,,,,,,,,"drop","select",,,,,"local.get","local.set","local.tee","global.get","global.set",,,,"i32.load","i64.load","f32.load","f64.load","i32.load8_s","i32.load8_u","i32.load16_s","i32.load16_u","i64.load8_s","i64.load8_u","i64.load16_s","i64.load16_u","i64.load32_s","i64.load32_u","i32.store","i64.store","f32.store","f64.store","i32.store8","i32.store16","i64.store8","i64.store16","i64.store32","memory.size","memory.grow","i32.const","i64.const","f32.const","f64.const","i32.eqz","i32.eq","i32.ne","i32.lt_s","i32.lt_u","i32.gt_s","i32.gt_u","i32.le_s","i32.le_u","i32.ge_s","i32.ge_u","i64.eqz","i64.eq","i64.ne","i64.lt_s","i64.lt_u","i64.gt_s","i64.gt_u","i64.le_s","i64.le_u","i64.ge_s","i64.ge_u","f32.eq","f32.ne","f32.lt","f32.gt","f32.le","f32.ge","f64.eq","f64.ne","f64.lt","f64.gt","f64.le","f64.ge","i32.clz","i32.ctz","i32.popcnt","i32.add","i32.sub","i32.mul","i32.div_s","i32.div_u","i32.rem_s","i32.rem_u","i32.and","i32.or","i32.xor","i32.shl","i32.shr_s","i32.shr_u","i32.rotl","i32.rotr","i64.clz","i64.ctz","i64.popcnt","i64.add","i64.sub","i64.mul","i64.div_s","i64.div_u","i64.rem_s","i64.rem_u","i64.and","i64.or","i64.xor","i64.shl","i64.shr_s","i64.shr_u","i64.rotl","i64.rotr","f32.abs","f32.neg","f32.ceil","f32.floor","f32.trunc","f32.nearest","f32.sqrt","f32.add","f32.sub","f32.mul","f32.div","f32.min","f32.max","f32.copysign","f64.abs","f64.neg","f64.ceil","f64.floor","f64.trunc","f64.nearest","f64.sqrt","f64.add","f64.sub","f64.mul","f64.div","f64.min","f64.max","f64.copysign","i32.wrap_i64","i32.trunc_f32_s","i32.trunc_f32_u","i32.trunc_f64_s","i32.trunc_f64_u","i64.extend_i32_s","i64.extend_i32_u","i64.trunc_f32_s","i64.trunc_f32_u","i64.trunc_f64_s","i64.trunc_f64_u","f32.convert_i32_s","f32.convert_i32_u","f32.convert_i64_s","f32.convert_i64_u","f32.demote_f64","f64.convert_i32_s","f64.convert_i32_u","f64.convert_i64_s","f64.convert_i64_u","f64.promote_f32","i32.reinterpret_f32","i64.reinterpret_f64","f32.reinterpret_i32","f64.reinterpret_i64"],S={get_local:"local.get",set_local:"local.set",tee_local:"local.tee",get_global:"global.get",set_global:"global.set","i32.trunc_s/f32":"i32.trunc_f32_s","i32.trunc_u/f32":"i32.trunc_f32_u","i32.trunc_s/f64":"i32.trunc_f64_s","i32.trunc_u/f64":"i32.trunc_f64_u","i64.extend_s/i32":"i64.extend_i32_s","i64.extend_u/i32":"i64.extend_i32_u","i64.trunc_s/f32":"i64.trunc_f32_s","i64.trunc_u/f32":"i64.trunc_f32_u","i64.trunc_s/f64":"i64.trunc_f64_s","i64.trunc_u/f64":"i64.trunc_f64_u","f32.convert_s/i32":"f32.convert_i32_s","f32.convert_u/i32":"f32.convert_i32_u","f32.convert_s/i64":"f32.convert_i64_s","f32.convert_u/i64":"f32.convert_i64_u","f32.demote/f64":"f32.demote_f64","f64.convert_s/i32":"f64.convert_i32_s","f64.convert_u/i32":"f64.convert_i32_u","f64.convert_s/i64":"f64.convert_i64_s","f64.convert_u/i64":"f64.convert_i64_u","f64.promote/f32":"f64.promote_f32"};for(let[s,e]of q.entries())e!=null&&(p[e]=s);p["i32.trunc_sat_f32_s"]=[252,0];p["i32.trunc_sat_f32_u"]=[252,1];p["i32.trunc_sat_f64_s"]=[252,2];p["i32.trunc_sat_f64_u"]=[252,3];p["i64.trunc_sat_f32_s"]=[252,4];p["i64.trunc_sat_f32_u"]=[252,5];p["i64.trunc_sat_f64_s"]=[252,6];p["i64.trunc_sat_f64_u"]=[252,7];p["memory.init"]=[252,8];p["data.drop"]=[252,9];p["memory.copy"]=[252,10];p["memory.fill"]=[252,11];p["table.init"]=[252,12];p["elem.drop"]=[252,13];p["table.copy"]=[252,14];p["table.grow"]=[252,15];p["table.size"]=[252,16];p["table.fill"]=[252,17];for(let s in S){let e=q.indexOf(S[s]);p[s]=e}var w={};for(let s in p){w[s]=j(s);let[e,t]=s.split(".");t!=null&&(p[e]=p[e]??{},p[e][t]=p[s],w[e]=w[e]??{},w[e][t]=j(s))}var C={"i32.load":4,"i64.load":8,"f32.load":4,"f64.load":8,"i32.load8_s":1,"i32.load8_u":1,"i32.load16_s":2,"i32.load16_u":2,"i64.load8_s":1,"i64.load8_u":1,"i64.load16_s":2,"i64.load16_u":2,"i64.load32_s":4,"i64.load32_u":4,"i32.store":4,"i64.store":8,"f32.store":4,"f64.store":8,"i32.store8":1,"i32.store16":2,"i64.store8":1,"i64.store16":2,"i64.store32":4};function*A(s){for(s=te(s);;){let e=Number(s&0x7Fn);if(s>>=7n,s===0n&&!(e&64)||s===-1n&&e&64){yield e;break}yield e|128}}function*G(s){let e=0,t=Math.ceil(Math.log2(Math.abs(s))),r=s<0,f=!0;for(;f;)e=s&127,s=s>>7,r&&(s=s|-(1<<t-7)),s==0&&!(e&64)||s==-1&&(e&64)==64?f=!1:e=e|128,yield e}function*b(s,e=0){if(s<0)throw new TypeError("uint value must be positive, received: "+s);let t=0;do t=s&127,s=s>>7,(s!=0||e>0)&&(t=t|128),yield t,e--;while(s!=0||e>-1)}var k=new DataView(new BigInt64Array(1).buffer);function te(s){return k.setBigInt64(0,s),k.getBigInt64(0)}function*P(s){k.setFloat32(0,s);for(let e=4;e--;)yield k.getUint8(e)}function*$(s){k.setFloat64(0,s);for(let e=8;e--;)yield k.getUint8(e)}function D(s){s=s.toUpperCase();let e=s.indexOf("P"),t,r;e!==-1?(t=s.substring(0,e),r=parseInt(s.substring(e+1))):(t=s,r=0);let f=t.indexOf(".");if(f!==-1){let _=parseInt(t.substring(0,f),16),x=Math.sign(_);_=x*_;let g=t.length-f-1,u=parseInt(t.substring(f+1),16),c=g>0?u/Math.pow(16,g):0;x===0?c===0?t=x:Object.is(x,-0)?t=-c:t=c:t=x*(_+c)}else t=parseInt(t,16);return t*(e!==-1?Math.pow(2,r):1)}var re=2147483648,ne=2139095040;function*H(s){let e=parseInt(s.split("nan:")[1]);e|=ne,s[0]==="-"&&(e|=re),k.setInt32(0,e);for(let t=4;t--;)yield k.getUint8(t)}var ie=0x8000000000000000n,se=0x7ff0000000000000n;function*V(s){let e=BigInt(s.split("nan:")[1]);e|=se,s[0]==="-"&&(e|=ie),k.setBigInt64(0,e);for(let t=8;t--;)yield k.getUint8(t)}(function(s){function e(){}function t(u,c){if(u=u===void 0?"utf-8":u,c=c===void 0?{fatal:!1}:c,x.indexOf(u.toLowerCase())===-1)throw new RangeError("Failed to construct 'TextDecoder': The encoding label provided ('"+u+"') is invalid.");if(c.fatal)throw Error("Failed to construct 'TextDecoder': the 'fatal' option is unsupported.")}function r(u){return Buffer.from(u.buffer,u.byteOffset,u.byteLength).toString("utf-8")}function f(u){var c=URL.createObjectURL(new Blob([u],{type:"text/plain;charset=UTF-8"}));try{var n=new XMLHttpRequest;return n.open("GET",c,!1),n.send(),n.responseText}catch{return _(u)}finally{URL.revokeObjectURL(c)}}function _(u){for(var c=0,n=Math.min(65536,u.length+1),i=new Uint16Array(n),l=[],o=0;;){var a=c<u.length;if(!a||o>=n-1){if(l.push(String.fromCharCode.apply(null,i.subarray(0,o))),!a)return l.join("");u=u.subarray(c),o=c=0}if(a=u[c++],!(a&128))i[o++]=a;else if((a&224)===192){var h=u[c++]&63;i[o++]=(a&31)<<6|h}else if((a&240)===224){h=u[c++]&63;var m=u[c++]&63;i[o++]=(a&31)<<12|h<<6|m}else if((a&248)===240){h=u[c++]&63,m=u[c++]&63;var y=u[c++]&63;a=(a&7)<<18|h<<12|m<<6|y,65535<a&&(a-=65536,i[o++]=a>>>10&1023|55296,a=56320|a&1023),i[o++]=a}}}if(s.TextEncoder&&s.TextDecoder)return!1;var x=["utf-8","utf8","unicode-1-1-utf-8"];Object.defineProperty(e.prototype,"encoding",{value:"utf-8"}),e.prototype.encode=function(u,c){if(c=c===void 0?{stream:!1}:c,c.stream)throw Error("Failed to encode: the 'stream' option is unsupported.");c=0;for(var n=u.length,i=0,l=Math.max(32,n+(n>>>1)+7),o=new Uint8Array(l>>>3<<3);c<n;){var a=u.charCodeAt(c++);if(55296<=a&&56319>=a){if(c<n){var h=u.charCodeAt(c);(h&64512)===56320&&(++c,a=((a&1023)<<10)+(h&1023)+65536)}if(55296<=a&&56319>=a)continue}if(i+4>o.length&&(l+=8,l*=1+c/u.length*2,l=l>>>3<<3,h=new Uint8Array(l),h.set(o),o=h),!(a&4294967168))o[i++]=a;else{if(!(a&4294965248))o[i++]=a>>>6&31|192;else if(!(a&4294901760))o[i++]=a>>>12&15|224,o[i++]=a>>>6&63|128;else if(!(a&4292870144))o[i++]=a>>>18&7|240,o[i++]=a>>>12&63|128,o[i++]=a>>>6&63|128;else continue;o[i++]=a&63|128}}return o.slice?o.slice(0,i):o.subarray(0,i)},Object.defineProperty(t.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(t.prototype,"fatal",{value:!1}),Object.defineProperty(t.prototype,"ignoreBOM",{value:!1});var g=_;typeof Buffer=="function"&&Buffer.from?g=r:typeof Blob=="function"&&typeof URL=="function"&&typeof URL.createObjectURL=="function"&&(g=f),t.prototype.decode=function(u,c){if(c=c===void 0?{stream:!1}:c,c.stream)throw Error("Failed to decode: the 'stream' option is unsupported.");return u=u instanceof Uint8Array?u:u.buffer instanceof ArrayBuffer?new Uint8Array(u.buffer):new Uint8Array(u),g(u)},s.TextEncoder=e,s.TextDecoder=t})(typeof window<"u"?window:typeof global<"u"?global:globalThis);function j(s){return function(e,t){return oe(s,e!=null&&!Array.isArray(e)?[e]:e,t!=null&&!Array.isArray(t)?[t]:t)}}var ae={"f64.const":$,"f32.const":P};function*oe(s,e=[],t=[]){for(let r of t)switch(typeof r){case"number":yield r;break;default:yield*r;break}yield*Array.isArray(p[s])?p[s]:[p[s]];for(let r of e)switch(typeof r){case"bigint":yield*A(r);break;case"number":yield*(ae[s]??G)(r);break;default:yield*r}}var le=new TextEncoder("utf-8");function F(s){return[...le.encode(s)]}function X(){return[...F("\0asm"),1,0,0,0]}function d(s,e){return[p.section[s],...b(e.length),...e]}function v(s){return[...b(s.length),...s.flat()]}function ue(s){let e=[],t=[],r;for(let f of s)f!==r&&t.length&&(e.push([...b(t.length),p.type[t[0]]]),t=[]),t.push(f),r=f;return t.length&&e.push([...b(t.length),p.type[t[0]]]),e}function R(s,e,t){return t!=null?[p.limits.shared,...b(s),...b(e)]:e!=null?[p.limits.minmax,...b(s),...b(e)]:[p.limits.min,...b(s)]}d.type=function(s){return d("type",v(s.map(([e,t])=>[p.type.func,...v(e.map(r=>p.type[r])),...v(t.map(r=>p.type[r]))])))};d.import=function(s){return d("import",v(s.map(([e,t,r,f])=>[...v(F(e)),...v(F(t)),p.import[r],...{func:()=>f.map(_=>[...b(_)]),memory:()=>R(...f)}[r]()])))};d.function=function(s){return d("function",v(s.map(e=>[...b(e)])))};d.table=function(s){return d("table",v(s.map(([e,t,r])=>[p.type[e],...R(t,r)])))};d.memory=function(s){return d("memory",v(s.map(([e,t])=>R(e,t))))};d.global=function(s){return d("global",v(s.map(([e,t,r])=>[p.type[t],p.global[e],...r,p.end])))};d.export=function(s){return d("export",v(s.map(([e,t,r])=>[...v(F(e)),p.export[t],...b(r)])))};d.start=function(s){return d("start",[...b(s)])};d.element=function(s){return d("element",v(s.map(([e,t,r])=>[...b(e),...t,p.end,...v(r)])))};d.code=function(s){return d("code",v(s.map(([e,t])=>v([...v(ue(e)),...t,p.end]))))};d.data=function(s){return d("data",v(s.map(([e,t,r])=>[...b(e),...t,p.end,...v(r)])))};var z=class extends Array{log=[];write(e,t){return this.log.push(e,t),this.push(...e),this}get buffer(){return new Uint8Array(this)}},O=class{types=[];imports=[];tables=[];memories=[];globals=[];exports=[];starts="";elements=[];codes=[];datas=[];constructor(e){e&&Object.assign(this,e)}get funcs(){return this.codes.filter(e=>!e.imported)}ensureType(e,t){let r=[e.join(" "),t.join(" ")].join(),f=this.types.indexOf(r);return f>=0?f:this.types.push(r)-1}getGlobalIndexOf(e){return this.globals.find(t=>t.name===e).idx}getFunc(e){return this.codes.find(t=>t.name===e)}getMemory(e){return this.memories.find(t=>t.name===e)}getType(e){return this.types[e]}type(e,t,r){return this.types[e]=this.ensureType(t,r),this}import(e,t,r,f,_,x){if(e==="func"){let g=this._func(t,_,x,[],[],!1,!0);this.imports.push({mod:r,field:f,type:e,desc:[g.type_idx]})}else e==="memory"&&this.imports.push({mod:r,field:f,type:e,desc:_});return this}table(e,t,r){return this.tables.push({type:e,min:t,max:r}),this}memory(e,t,r){return this.memories.push({name:e,min:t,max:r}),this}global(e,t,r,f){let _=this.globals.length;return this.globals.push({idx:_,name:e,valtype:r,mut:t,expr:f}),this}export(e,t,r){return this.exports.push({type:e,name:t,export_name:r}),this}start(e){return this.starts=e,this}elem(e,t){return this.elements.push({offset_idx_expr:e,codes:t}),this}_func(e,t=[],r=[],f=[],_=[],x=!1,g=!1){let u=this.ensureType(t,r),n={idx:this.codes.length,name:e,type_idx:u,locals:f,body:_,imported:g};return this.codes.push(n),x&&this.export("func",e,e),n}func(...e){return this._func(...e),this}data(e,t){return this.datas.push({offset_idx_expr:e,bytes:t}),this}build({metrics:e=!0}={}){let t=new z;t.write(X()),this.types.length&&t.write(d.type(this.types.map(r=>r.split(",").map(f=>f.split(" ").filter(Boolean))))),this.imports.length&&t.write(d.import(this.imports.map(r=>[r.mod,r.field,r.type,r.desc]))),this.funcs.length&&t.write(d.function(this.funcs.map(r=>r.type_idx))),this.elements.length&&t.write(d.table(this.tables.map(r=>[r.type,r.min,r.max]))),this.memories.length&&t.write(d.memory(this.memories.map(r=>[r.min,r.max]))),this.globals.length&&t.write(d.global(this.globals.map(r=>[r.mut,r.valtype,r.expr]))),this.exports.length&&t.write(d.export(this.exports.map(r=>r.type==="func"?[r.export_name,r.type,this.getFunc(r.name).idx]:r.type==="memory"?[r.export_name,r.type,this.getMemory(r.name).idx]:r.type==="global"?[r.export_name,r.type,this.getGlobalIndexOf(r.name)]:[]))),this.starts.length&&t.write(d.start(this.getFunc(this.starts).idx)),this.elements.length&&t.write(d.element(this.elements.map(r=>[0,r.offset_idx_expr,r.codes.map(f=>this.getFunc(f).idx)]))),this.funcs.length&&t.write(d.code(this.funcs.map(r=>[r.locals,r.body]))),this.datas.length&&t.write(d.data(this.datas.map(r=>[0,r.offset_idx_expr,r.bytes])));return t}};var E=class{globals=[];types=[];funcs=[];constructor(e){e&&(Object.assign(this,e),this.funcs.forEach(function(r){r.context=new M(this,r.context)}))}lookup(e,t){let r;switch(t){case"call":r=this.funcs.map(f=>f.name).lastIndexOf(e);break;case"type":r=this.types.map(f=>f.name).lastIndexOf(e);break;default:r=this.globals.map(f=>f.name).lastIndexOf(e)}if(!~r)throw new ReferenceError(`lookup failed at: ${t} "${e}"`);return b(r)}},M=class{#e=null;locals=[];depth=[];constructor(e,t){this.#e=e,t&&Object.assign(this,t)}lookup(e,t){let r;switch(t){case"br":case"br_table":case"br_if":r=this.depth.lastIndexOf(e),~r&&(r=this.depth.length-1-r);break;default:r=this.locals.lastIndexOf(e)}return~r?b(r):this.#e.lookup(e,t)}};function U(s,e,t){let r=new O(e),f=new E(t),_=[];function x(n,i=f,l="i32"){switch(n.kind){case"number":{if(n.value==="inf"||n.value==="+inf")return 1/0;if(n.value==="-inf")return-1/0;if(n.value==="nan"||n.value==="+nan")return NaN;if(n.value==="-nan")return NaN;if(l?.[0]==="f")return parseFloat(n.value)}case"hex":{let o;return l.indexOf("i64")===0?(n.value[0]==="-"?o=-BigInt(n.value.slice(1)):o=BigInt(n.value),o):l[0]==="f"?(n.value.indexOf("nan")>=0?l.indexOf("f32")===0?o=H(n.value):o=V(n.value):o=D(n.value),o):parseInt(n.value)}case"label":return i.lookup(n.value,l);default:return n.value}}function g(n,i,l){if(!(n in w)||typeof w[n]!="function")throw new Error("Unknown instruction: "+n);return[...w[n](i,l)]}function u(n,i=f){let l={offset:0,align:0},o=n.instr.value;switch(o){case"type":return r.getType(n.name.value);case"call_indirect":{let a=[u(n.children.shift(),i),0],h=n.children.flatMap(function(y){return u(y,i)});return g(o,a,h)}case"memory.grow":{let a=[0],h=n.children.flatMap(function(y){return u(y,i)});return g(o,a,h)}case"i32.load":case"i64.load":case"f32.load":case"f64.load":case"i32.load8_s":case"i32.load8_u":case"i32.load16_s":case"i32.load16_u":case"i64.load8_s":case"i64.load8_u":case"i64.load16_s":case"i64.load16_u":case"i64.load32_s":case"i64.load32_u":case"i32.store":case"i64.store":case"f32.store":case"f64.store":case"i32.store8":case"i32.store16":case"i64.store8":case"i64.store16":case"i64.store32":{l.align=C[o];for(let m of n.params)l[m.param.value]=x(m.value);let a=[Math.log2(l.align),l.offset].map(m=>{if(typeof m=="number")return b(m);if(typeof m=="bigint")return A(m)}),h=n.children.flatMap(function(y){return u(y,i)});return g(o,a,h)}case"func":{let a={name:n.name?.value??f.funcs.length,params:[],results:[]};f.funcs.push(a);for(let h of n.children)switch(h.instr.value){case"param":a.params.push(...h.children.map(m=>m.instr.value));break;case"result":a.results.push(...h.children.map(m=>m.instr.value));case"type":break}return[a.name,a.params,a.results]}case"result":return n.children.flatMap(function(h){return w.type[h.instr.value]()});case"else":case"then":return n.children.flatMap(function(h){return u(h,i)});case"if":{let a=n.name?.value??i.depth.length,h=[],m=[],y,I;i.depth.push(a);for(let T of n.children)switch(T.instr.value){case"result":h.push(u(T,i));break;case"else":m.push(...w.else());case"then":I=u(T,i),m.push(I);break;default:y?I?(m.push(...w.else()),m.push(u(T,i))):(I=u(T,i),m.push(I)):y=u(T,i)}return i.depth.pop(),h.length||h.push(w.type.void()),[...w.if(h.flat(),y),...m.flat(),...w.end()]}case"loop":case"block":{let a=n.name?.value??i.depth.length,h=[],m=[];i.depth.push(a);for(let y of n.children)switch(y.instr.value){case"result":h.push(u(y,i));break;default:m.push(u(y,i))}return i.depth.pop(),h.length||h.push(w.type.void()),[...w[o](),...h.flat().map(function(I){return[...I]}),...m.flat(),...w.end()]}case"br_table":{n.name&&n.params.unshift({param:{value:i.lookup(n.name.value,o)}});let a=n.params.map(m=>x(m.param,i,o)),h=n.children.flatMap(function(y){return u(y,i)});return g(o,[a.length-1,...a],h)}default:{n.name&&n.params.unshift({param:{value:(o.startsWith("global")?f:i).lookup(n.name.value,o)}});let a=n.params.map(m=>x(m.param,i,o)),h=n.children.flatMap(function(y){return u(y,i)});return g(o,a,h)}}}function c(n){switch(n.instr.value){case"module":n.children.forEach(function(l){c(l)});break;case"memory":{let i=n.name?.value??r.memories.length,l=n.params.map(o=>x(o.param)).flat();if(n.children?.[0]?.instr.value==="export"){let o=n.children[0].params[0].param.value,a=n.children[0].name?.value??i??0;r.export("memory",a,o)}r.memory(i,...l)}break;case"data":{let i=n.children.shift(),l=n.children.shift().data;r.data(u(i),l)}break;case"start":r.start(n.name.value);break;case"table":{let i=n.params.map(l=>x(l.param));i.unshift(i.pop()),r.table(...i)}break;case"elem":{let i=n.children.shift(),l=n.children.map(o=>o.ref.value);r.elem(u(i),l)}break;case"import":if(n.children[0].instr.value==="func"){let i=n.params.map(a=>x(a.param)),l=u(n.children[0]),o=l.shift();if(n.children?.[0]?.children?.[0]?.instr.value==="type"){let a=n.children?.[0]?.children?.[0]?.name.value,h=r.getType(a);l=r.types[h].split(",").map(y=>y.split(" "))}r.import("func",o,...i,...l)}else if(n.children[0].instr.value==="memory"){let i=n.children[0],l=n.params.map(h=>x(h.param)),o=i.instr.name,a=i.params.map(h=>x(h.param));r.import("memory",o,...l,a)}break;case"global":{let i={name:n.name?.value??r.globals.length,vartype:"const",type:n.children[0].instr.value};if(f.globals.push(i),i.type==="export"){let o=n.children.shift().params[0].param.value;r.export("global",i.name,o),i.type=n.children[0].instr.value}i.type==="mut"&&(i.vartype="var",i.type=n.children[0].children[0].instr.value);let l=n.children[1];r.global(i.name,i.vartype,i.type,u(l))}break;case"type":{let i={name:n.name?.value??r.types.length,params:[],results:[]};f.types.push(i);for(let l of n.children[0].children)switch(l.instr.value){case"param":i.params.push(...l.children.map(o=>o.instr.value));break;case"result":i.results.push(...l.children.map(o=>o.instr.value));break}r.type(i.name,i.params,i.results)}break;case"export":{let i={name:n.params[0].param.value};i.type=n.children[0].instr.value,i.internal_name=n.children[0].name.value,r.export(i.type,i.internal_name,i.name)}break;case"func":{let i={name:n.name?.value??f.funcs.length,context:new M(f),params:[],results:[],locals:[],body:[]};f.funcs.push(i);for(let l of n.children)switch(l.instr.value){case"export":{let o=l.params[0].param.value;r.export("func",i.name,o)}break;case"local":i.locals.push(...l.children.map(o=>o.instr.value)),i.context.locals.push(...l.children.map(()=>l.name?.value));break;case"param":i.params.push(...l.children.map(o=>o.instr.value)),i.context.locals.push(...l.children.map(()=>l.name?.value));break;case"result":i.results.push(...l.children.map(o=>o.instr.value));break;case"type":break;default:i.body.push(l)}_.push(function(){r.func(i.name,i.params,i.results,i.locals,[...i.body.flatMap(function(a){return u(a,i.context)})])})}break}}return c(s),_.forEach(function(i){i()}),{module:r,global:f}}var fe=new RegExp([/(?<comment>;;.*|\(;[^]*?;\))/,/"(?<string>(?:\\"|[^"])*?)"/,/(?<param>offset|align|shared|funcref)=?/,/(?<hex>([+-]?nan:)?[+-]?0x[0-9a-f.p+-_]+)/,/(?<number>[+-]?inf|[+-]?nan|[+-]?\d[\d.e_+-]*)/,/(?<instr>[a-z][a-z0-9!#$%&'*+\-./:<=>?@\\^_`|~]+)/,/\$(?<label>[a-z0-9!#$%&'*+\-./:<=>?@\\^_`|~]+)/,/(?<lparen>\()|(?<rparen>\))|(?<nul>[ \t\n]+)|(?<error>.)/].map(s=>s.toString().slice(1,-1)).join("|"),"gi");function L(s){let e={},t={},r=s.matchAll(fe);function f(){let n=r.next();if(n.done)return{value:{value:null,kind:"eof",index:s.length},done:!0};let[i,l]=Object.entries(n.value.groups).filter(o=>o[1]!=null)[0];return{value:{value:l,kind:i,index:n.value.index},done:!1}}function _(){e=t;do t=f().value;while(t.kind==="nul"||t.kind==="comment");return e}function x(n,i){return n!=null?i!=null?i===t.value:n===t.kind:t}function g(n,i){if(n===t.kind)if(i!=null){if(i===t.value)return _()}else return _();return null}function u(n,i){let l=g(n,i);if(!l)throw new SyntaxError("Unexpected token: "+t.value+`
        expected: `+n+(i?' "'+i+'"':"")+`
    but received: `+t.kind+`
     at position: `+t.index);return l}return{[Symbol.iterator](){return this},next:f,advance:_,peek:x,accept:g,expect:u,start:_}}function B({start:s,peek:e,accept:t,expect:r}){let f=new TextEncoder("utf-8"),_=/[0-9a-f]/i,x={t:9,n:10,r:13,'"':34,"'":39,"\\":92};function g(){let n=[];for(;;){let i=t("string");if(!i)break;for(let l=0,o,a;l<i.value.length;l++){if(o=i.value[l],o==="\\"){if(a=i.value[l+1],a in x){n.push(x[a]),l++;continue}else if(_.test(a)){_.test(i.value[l+2])?n.push(parseInt(`${a}${i.value[l+=2]}`,16)):(n.push(parseInt(a,16)),l++);continue}}n.push(f.encode(o))}}return n}function*u(){let n;for(;;){if(n=t("number")){n.value=n.value.replace(/_/g,""),yield{param:n};continue}if(n=t("hex")){n.value=n.value.replace(/_/g,""),yield{param:n};continue}if(n=t("string")){yield{param:n};continue}if(n=t("label")){yield{param:n};continue}if(n=t("param")){let i;if(i=t("number")){yield{param:n,value:i};continue}if(i=t("hex")){yield{param:n,value:i};continue}else{yield{param:n};continue}}break}}function c(){let n=t("label");if(n)return{ref:n};if(e("string"))return{data:g()};let i=t("lparen"),l;if(i)l=r("instr");else if(l=t("instr"),!l)return;let o={instr:l,name:t("label"),params:[...u()],children:[]};if(i){let a;for(;!e("eof")&&(a=c());)o.children.push(a);o.params.push(...u()),r("rparen")}else if(l.value==="block"||l.value==="loop"){let a;for(;!e("eof")&&!e("instr","end")&&(a=c());)o.children.push(a);r("instr","end")}return o}return s(),c()}function Y(s,e,t={}){return U(B(L("(module "+s+")")),t.module,t.global).module.build(e).buffer}return ee(ce);})();
//!time 'module build'
//!timeEnd 'module build'
